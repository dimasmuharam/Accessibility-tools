<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <title>Download Seluruh Data Kampus Indonesia - Aksesibel</title>
    <style>
        body { font-family: sans-serif; max-width: 900px; margin: 2rem auto; padding: 20px; line-height: 1.8; color: #1a1a1a; }
        .box { border: 4px solid #000; padding: 2rem; border-radius: 20px; background: #f9f9f9; }
        button { padding: 20px; font-size: 1.1rem; font-weight: 800; cursor: pointer; background: #000; color: #fff; border: none; border-radius: 10px; margin-bottom: 1rem; width: 100%; }
        button:hover { background: #333; }
        textarea { width: 100%; height: 300px; font-family: monospace; padding: 15px; border: 2px solid #ccc; border-radius: 10px; }
        .status { padding: 15px; background: #e0f2f1; border-left: 10px solid #00695c; margin-bottom: 1rem; font-weight: bold; }
    </style>
</head>
<body>
    <div class="box" role="main">
        <h1>Pengambil Data Seluruh Kampus Indonesia</h1>
        <p>Halaman ini akan menarik data dari database PDDikti secara otomatis untuk kebutuhan database riset Mas Dimas.</p>
        
        <button onclick="fetchAllData()" id="btnFetch">1. Ambil Seluruh Data Kampus Indonesia</button>
        
        <div id="status" class="status" role="status">Status: Siap digunakan.</div>

        <button onclick="copySql()" id="btnCopy" style="background: #00695c;">2. Salin Kode SQL untuk Supabase</button>
        
        <label for="sqlOutput">Hasil Kode SQL (Textarea):</label>
        <textarea id="sqlOutput" readonly aria-describedby="status"></textarea>
    </div>

    <script>
        async function fetchAllData() {
            const status = document.getElementById('status');
            const output = document.getElementById('sqlOutput');
            const btn = document.getElementById('btnFetch');
            
            btn.disabled = true;
            status.innerText = "Status: Sedang mengambil data massal dari PDDikti... Mohon tunggu (10-20 detik).";
            
            // Daftar prefix pencarian untuk mendapatkan cakupan maksimal (A-Z)
            const alphabets = "abcdefghijklmnopqrstuvwxyz".split("");
            let allNames = new Set();

            try {
                for (let char of alphabets) {
                    status.innerText = `Status: Mengambil data awalan huruf ${char.toUpperCase()}...`;
                    const response = await fetch(`https://api-frontend.kemdikbud.go.id/hit_mhs/${char}`);
                    const data = await response.json();
                    
                    if (data.pt) {
                        data.pt.forEach(item => {
                            let name = item.text.split(',')[0].trim();
                            allNames.add(name);
                        });
                    }
                }

                // Susun SQL
                let sql = "INSERT INTO public.campuses (id, name, updated_at)\nVALUES \n";
                const entries = Array.from(allNames).map(name => {
                    // Membersihkan tanda petik tunggal agar tidak error di SQL
                    const safeName = name.replace(/'/g, "''");
                    return `    (gen_random_uuid(), '${safeName}', now())`;
                });

                sql += entries.join(",\n");
                sql += "\nON CONFLICT (name) DO NOTHING;";

                output.value = sql;
                status.innerText = `✅ SELESAI! Berhasil menarik ${entries.length} nama kampus. Silakan klik tombol Salin.`;
            } catch (err) {
                status.innerText = "❌ Terjadi kesalahan koneksi. Silakan coba lagi.";
                console.error(err);
            } finally {
                btn.disabled = false;
            }
        }

        function copySql() {
            const textarea = document.getElementById('sqlOutput');
            textarea.select();
            document.execCommand('copy');
            alert("Kode SQL berhasil disalin ke clipboard!");
        }
    </script>
</body>
</html>
